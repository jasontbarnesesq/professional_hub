<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Time Tracker</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .settings-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
        }

        .settings-icon:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .mode-toggle {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
            margin-top: 15px;
            display: inline-flex;
            gap: 8px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
        }

        .content {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .settings-section p {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .input-group small {
            display: block;
            color: #666;
            margin-top: 4px;
            font-size: 13px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .notification-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-enabled {
            background: #10b981;
            color: white;
        }

        .badge-disabled {
            background: #ef4444;
            color: white;
        }

        .chat-container {
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .assistant-message {
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .assistant-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .assistant-text {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            border-top-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 80%;
        }

        .user-message {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .user-text {
            background: #667eea;
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            border-top-right-radius: 4px;
            max-width: 80%;
        }

        .voice-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .voice-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(102, 126, 234, 0.6);
        }

        .voice-btn.listening {
            animation: pulse 1.5s infinite;
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 24px rgba(239, 68, 68, 0.6);
            }
        }

        .status-text {
            color: #666;
            font-size: 14px;
            text-align: center;
        }

        .status-text.ready {
            color: #10b981;
            font-weight: 600;
        }

        .mic-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 6px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .manual-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .manual-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
        }

        .manual-input button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .entries-summary {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .entries-summary h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .entry-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .entry-time {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .entry-detail {
            margin-bottom: 6px;
            font-size: 14px;
            color: #555;
        }

        .entry-detail strong {
            color: #333;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .type-billable {
            background: #10b981;
            color: white;
        }

        .type-non-billable {
            background: #6b7280;
            color: white;
        }

        .type-pending {
            background: #f59e0b;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .total-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
        }

        .total-display h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .total-display .total {
            font-size: 28px;
            font-weight: 700;
        }

        .hidden {
            display: none;
        }

        .browser-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #92400e;
        }

        .browser-warning strong {
            display: block;
            margin-bottom: 8px;
        }

        .alert-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #1e40af;
        }

        .alert-box strong {
            display: block;
            margin-bottom: 8px;
        }

        .success-box {
            background: #d1fae5;
            border: 2px solid #10b981;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #065f46;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="settings-icon" onclick="openSettings()">‚öôÔ∏è</div>
            <h1>üé§ Voice Time Tracker</h1>
            <p>Speak your time entries naturally</p>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('voice')">Voice Mode</button>
                <button class="mode-btn" onclick="setMode('manual')">Manual Mode</button>
            </div>
        </div>

        <div class="content">
            <div id="browserWarning" class="browser-warning hidden">
                <strong>‚ö†Ô∏è Browser Compatibility Notice</strong>
                Voice recognition works best in Chrome, Edge, or Safari. If you're using Firefox or another browser, please switch to manual mode.
            </div>

            <div id="notificationAlert" class="alert-box hidden">
                <strong>üîî Daily Reminders Available!</strong>
                Click the settings icon (‚öôÔ∏è) in the top right to set up automatic daily reminders to track your time.
            </div>

            <!-- Voice Mode -->
            <div id="voiceMode">
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant-message">
                        <div class="assistant-avatar">ü§ñ</div>
                        <div class="assistant-text">
                            Hi! I'm your time tracking assistant. I'll ask for microphone permission once, then you can use voice input anytime. Click the microphone button when you're ready to start your first entry!
                        </div>
                    </div>
                </div>

                <div class="voice-controls">
                    <div style="flex: 1; text-align: center;">
                        <button class="voice-btn" id="voiceBtn" onclick="toggleListening()">
                            üé§
                        </button>
                        <div class="status-text" id="statusText">Click to start speaking</div>
                    </div>
                </div>

                <div class="manual-input">
                    <input type="text" id="manualResponse" placeholder="Or type your response here..." onkeypress="handleKeyPress(event)">
                    <button onclick="submitManualResponse()">Send</button>
                </div>
            </div>

            <!-- Manual Mode -->
            <div id="manualMode" class="hidden">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="display: block; color: #667eea; font-weight: 600; margin-bottom: 8px;">Client Name</label>
                    <input type="text" id="clientName" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="display: block; color: #667eea; font-weight: 600; margin-bottom: 8px;">Client Matter</label>
                    <input type="text" id="clientMatter" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="display: block; color: #667eea; font-weight: 600; margin-bottom: 8px;">Time Type</label>
                    <select id="timeType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="billable">Billable</option>
                        <option value="non-billable">Non-Billable</option>
                        <option value="billable-pending">Billable-Pending</option>
                    </select>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="display: block; color: #667eea; font-weight: 600; margin-bottom: 8px;">Work Narrative</label>
                    <textarea id="narrative" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; min-height: 100px;"></textarea>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="display: block; color: #667eea; font-weight: 600; margin-bottom: 8px;">Total Time (hours)</label>
                    <input type="number" id="totalTime" step="0.1" min="0" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="clearManualForm()">Clear</button>
                    <button class="btn btn-primary" onclick="addManualEntry()">Add Entry</button>
                </div>
            </div>

            <!-- Entries Summary -->
            <div class="entries-summary">
                <h3>
                    Today's Entries
                    <span id="entryCount" style="font-size: 14px; color: #666; font-weight: normal;">0 entries</span>
                </h3>
                <div id="entriesContainer"></div>
                
                <div id="totalSection" class="hidden">
                    <div class="total-display">
                        <h4>Total Time Tracked</h4>
                        <div class="total" id="totalHours">0.0 hours</div>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="exportAsText()">Export Text</button>
                        <button class="btn btn-primary" onclick="exportAsCSV()">Export CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>

            <div class="settings-section">
                <h3>Google Drive Integration</h3>
                <p>Automatically save exported CSV files to Google Drive.</p>
                
                <div class="toggle-switch" style="margin-bottom: 15px;">
                    <label class="switch">
                        <input type="checkbox" id="driveToggle" onchange="toggleGoogleDrive()">
                        <span class="slider"></span>
                    </label>
                    <span id="driveStatus">
                        <span class="notification-badge badge-disabled">Not Connected</span>
                    </span>
                </div>

                <div id="driveSetup" class="hidden">
                    <div class="alert-box" style="margin-bottom: 15px;">
                        <strong>‚ÑπÔ∏è Setup Required</strong>
                        To use Google Drive integration, you'll need to set up Google API credentials. Click the button below for instructions.
                    </div>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="showDriveSetupInstructions()">
                        View Setup Instructions
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Daily Reminders</h3>
                <p>Get notified every day to track your time entries.</p>
                
                <div class="toggle-switch" style="margin-bottom: 15px;">
                    <label class="switch">
                        <input type="checkbox" id="notificationToggle" onchange="toggleNotifications()">
                        <span class="slider"></span>
                    </label>
                    <span id="notificationStatus">
                        <span class="notification-badge badge-disabled">Disabled</span>
                    </span>
                </div>

                <div id="notificationSettings" class="hidden">
                    <div class="input-group">
                        <label>Reminder Time</label>
                        <input type="time" id="reminderTime" value="17:00">
                        <small>Choose what time you want to be reminded daily</small>
                    </div>

                    <div class="input-group">
                        <label>Days to Remind</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                <input type="checkbox" class="day-checkbox" value="1" checked> Monday
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                <input type="checkbox" class="day-checkbox" value="2" checked> Tuesday
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                <input type="checkbox" class="day-checkbox" value="3" checked> Wednesday
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                <input type="checkbox" class="day-checkbox" value="4" checked> Thursday
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                <input type="checkbox" class="day-checkbox" value="5" checked> Friday
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                <input type="checkbox" class="day-checkbox" value="6"> Saturday
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                <input type="checkbox" class="day-checkbox" value="0"> Sunday
                            </label>
                        </div>
                    </div>

                    <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="saveNotificationSettings()">
                        Save Reminder Settings
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Data Management</h3>
                <p>Manage your saved time entries.</p>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="clearAllEntries()">Clear All Entries</button>
                    <button class="btn btn-secondary" onclick="downloadBackup()">Download Backup</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>About</h3>
                <p style="margin-bottom: 8px;"><strong>Voice Time Tracker v1.0</strong></p>
                <p>A conversational time tracking tool for capturing billable hours through voice or manual entry.</p>
            </div>
        </div>
    </div>

    <script>
        // Google Drive API Configuration
        const GOOGLE_CLIENT_ID = '793659536177-g3e47i0ckqsi7fvun2ntps35dr4h2is1.apps.googleusercontent.com'; // User will need to replace this
        const GOOGLE_API_KEY = 'AIzaSyD_G5NSdYM1BypLyqBjvLKsRkOhLn7rM6Y'; // User will need to replace this
        const GOOGLE_DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let isGoogleDriveReady = false;
        let isGoogleSignedIn = false;

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        let currentMode = 'voice';

        // Notification settings
        let notificationSettings = {
            enabled: false,
            time: '17:00',
            days: [1, 2, 3, 4, 5] // Monday-Friday
        };

        // Conversation State
        let conversationState = {
            step: 'idle',
            currentEntry: {},
            waitingForResponse: false
        };

        // Entries Storage
        let entries = [];

        // Initialize
        window.addEventListener('load', () => {
            checkBrowserSupport();
            loadEntries();
            loadNotificationSettings();
            loadGoogleDriveSettings();
            renderEntries();
            checkDailyReminder();
            updateNotificationUI();
            
            // Initialize Google API
            gapi.load('client:auth2', initGoogleDrive);
            
            // Show notification alert if not enabled
            if (!notificationSettings.enabled && 'Notification' in window) {
                setTimeout(() => {
                    document.getElementById('notificationAlert').classList.remove('hidden');
                }, 2000);
            }
        });

        function checkBrowserSupport() {
            if (!SpeechRecognition) {
                document.getElementById('browserWarning').classList.remove('hidden');
                setMode('manual');
            } else {
                setupRecognition();
            }
        }

        function setupRecognition() {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                handleVoiceInput(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopListening();
                if (event.error === 'not-allowed') {
                    updateStatus('Microphone access denied. Please enable in browser settings.');
                } else {
                    updateStatus('Error occurred. Click to try again.');
                }
            };

            recognition.onend = () => {
                stopListening();
            };

            // Request microphone permission immediately
            requestMicrophonePermission();
        }

        async function requestMicrophonePermission() {
            try {
                // Request microphone access using getUserMedia
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Stop the stream immediately - we just needed permission
                stream.getTracks().forEach(track => track.stop());
                
                // Update UI to show mic is ready
                updateStatus('Microphone ready! Click to start speaking', true);
                
                // Store permission status
                localStorage.setItem('micPermissionGranted', 'true');
            } catch (error) {
                console.error('Microphone permission error:', error);
                updateStatus('Please allow microphone access to use voice mode');
                
                // Show a helpful message
                setTimeout(() => {
                    if (confirm('This app needs microphone access for voice input. Would you like to switch to Manual Mode instead?')) {
                        setMode('manual');
                    }
                }, 1000);
            }
        }

        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            if (!recognition) return;
            
            isListening = true;
            document.getElementById('voiceBtn').classList.add('listening');
            document.getElementById('voiceBtn').textContent = 'üî¥';
            updateStatus('Listening... speak now');
            
            try {
                recognition.start();
            } catch (e) {
                console.error('Recognition start error:', e);
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
            document.getElementById('voiceBtn').textContent = 'üé§';
            
            // Check if we have permission
            const hasPermission = localStorage.getItem('micPermissionGranted') === 'true';
            if (hasPermission) {
                updateStatus('Microphone ready! Click to start speaking', true);
            } else {
                updateStatus('Click to start speaking');
            }
            
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Already stopped
                }
            }
        }

        function updateStatus(text, isReady = false) {
            const statusElement = document.getElementById('statusText');
            
            if (isReady) {
                statusElement.innerHTML = '<span class="mic-indicator"></span>' + text;
                statusElement.classList.add('ready');
            } else {
                statusElement.textContent = text;
                statusElement.classList.remove('ready');
            }
        }

        function handleVoiceInput(transcript) {
            addUserMessage(transcript);
            processUserInput(transcript);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitManualResponse();
            }
        }

        function submitManualResponse() {
            const input = document.getElementById('manualResponse');
            const text = input.value.trim();
            
            if (text) {
                addUserMessage(text);
                processUserInput(text);
                input.value = '';
            }
        }

        function processUserInput(input) {
            const state = conversationState;

            switch (state.step) {
                case 'idle':
                    state.step = 'awaiting_client';
                    state.currentEntry = {};
                    addAssistantMessage("Great! What's the client name?");
                    break;

                case 'awaiting_client':
                    state.currentEntry.clientName = input;
                    state.step = 'awaiting_matter';
                    addAssistantMessage(`Got it, ${input}. What's the client matter or project?`);
                    break;

                case 'awaiting_matter':
                    state.currentEntry.clientMatter = input;
                    state.step = 'awaiting_type';
                    addAssistantMessage("What type of time is this? Say 'billable', 'non-billable', or 'billable-pending'.");
                    break;

                case 'awaiting_type':
                    const type = parseTimeType(input);
                    if (type) {
                        state.currentEntry.timeType = type;
                        state.step = 'awaiting_narrative';
                        addAssistantMessage("Perfect. Now, please describe the work you performed.");
                    } else {
                        addAssistantMessage("I didn't catch that. Please say 'billable', 'non-billable', or 'billable-pending'.");
                    }
                    break;

                case 'awaiting_narrative':
                    state.currentEntry.narrative = input;
                    state.step = 'awaiting_time';
                    addAssistantMessage("Almost done! How much time did you spend? Just give me the number of hours.");
                    break;

                case 'awaiting_time':
                    const time = parseTime(input);
                    if (time > 0) {
                        state.currentEntry.totalTime = time;
                        saveCurrentEntry();
                        state.step = 'idle';
                        addAssistantMessage(`Excellent! I've recorded ${time} hours for ${state.currentEntry.clientName}. Would you like to add another entry?`);
                    } else {
                        addAssistantMessage("I need a valid time amount. Please tell me the number of hours, like '2' or '1.5'.");
                    }
                    break;
            }
        }

        function parseTimeType(input) {
            const lower = input.toLowerCase();
            if (lower.includes('billable') && lower.includes('pending')) {
                return 'billable-pending';
            } else if (lower.includes('non') || lower.includes('not billable')) {
                return 'non-billable';
            } else if (lower.includes('billable')) {
                return 'billable';
            }
            return null;
        }

        function parseTime(input) {
            const matches = input.match(/(\d+\.?\d*)/);
            if (matches) {
                return parseFloat(matches[1]);
            }
            return 0;
        }

        function saveCurrentEntry() {
            const entry = {
                id: Date.now(),
                date: new Date().toISOString(),
                ...conversationState.currentEntry
            };
            entries.push(entry);
            saveEntries();
            renderEntries();
        }

        function addAssistantMessage(text) {
            const container = document.getElementById('chatContainer');
            const msg = document.createElement('div');
            msg.className = 'message assistant-message';
            msg.innerHTML = `
                <div class="assistant-avatar">ü§ñ</div>
                <div class="assistant-text">${text}</div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.1;
                speechSynthesis.speak(utterance);
            }
        }

        function addUserMessage(text) {
            const container = document.getElementById('chatContainer');
            const msg = document.createElement('div');
            msg.className = 'message user-message';
            msg.innerHTML = `<div class="user-text">${text}</div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function setMode(mode, event) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'voice') {
                document.getElementById('voiceMode').classList.remove('hidden');
                document.getElementById('manualMode').classList.add('hidden');
                // Find and activate the voice mode button
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    if (btn.textContent.includes('Voice')) {
                        btn.classList.add('active');
                    }
                });
            } else {
                document.getElementById('voiceMode').classList.add('hidden');
                document.getElementById('manualMode').classList.remove('hidden');
                // Find and activate the manual mode button
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    if (btn.textContent.includes('Manual')) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function addManualEntry() {
            const clientName = document.getElementById('clientName').value.trim();
            const clientMatter = document.getElementById('clientMatter').value.trim();
            const timeType = document.getElementById('timeType').value;
            const narrative = document.getElementById('narrative').value.trim();
            const totalTime = parseFloat(document.getElementById('totalTime').value);

            if (!clientName || !clientMatter || !narrative || !totalTime || totalTime <= 0) {
                alert('Please fill in all fields with valid information');
                return;
            }

            const entry = {
                id: Date.now(),
                date: new Date().toISOString(),
                clientName,
                clientMatter,
                timeType,
                narrative,
                totalTime
            };

            entries.push(entry);
            saveEntries();
            renderEntries();
            clearManualForm();
        }

        function clearManualForm() {
            document.getElementById('clientName').value = '';
            document.getElementById('clientMatter').value = '';
            document.getElementById('timeType').value = 'billable';
            document.getElementById('narrative').value = '';
            document.getElementById('totalTime').value = '';
        }

        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            const totalSection = document.getElementById('totalSection');
            const entryCount = document.getElementById('entryCount');

            // Filter today's entries
            const today = new Date().toDateString();
            const todayEntries = entries.filter(e => new Date(e.date).toDateString() === today);

            entryCount.textContent = `${todayEntries.length} ${todayEntries.length === 1 ? 'entry' : 'entries'}`;

            if (todayEntries.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No entries yet for today</p>';
                totalSection.classList.add('hidden');
                return;
            }

            totalSection.classList.remove('hidden');

            const typeLabels = {
                'billable': 'Billable',
                'non-billable': 'Non-Billable',
                'billable-pending': 'Billable-Pending'
            };

            const typeClasses = {
                'billable': 'type-billable',
                'non-billable': 'type-non-billable',
                'billable-pending': 'type-pending'
            };

            container.innerHTML = todayEntries.map(entry => `
                <div class="entry-card">
                    <div class="entry-header">
                        <div class="entry-title">
                            ${entry.clientName}
                            <span class="type-badge ${typeClasses[entry.timeType]}">${typeLabels[entry.timeType]}</span>
                        </div>
                        <div class="entry-time">${entry.totalTime} hrs</div>
                    </div>
                    <div class="entry-detail"><strong>Matter:</strong> ${entry.clientMatter}</div>
                    <div class="entry-detail" style="margin-top: 8px; font-style: italic;">${entry.narrative}</div>
                </div>
            `).join('');

            const total = todayEntries.reduce((sum, entry) => sum + entry.totalTime, 0);
            document.getElementById('totalHours').textContent = `${total.toFixed(1)} hours`;
        }

        function saveEntries() {
            localStorage.setItem('voiceTimeEntries', JSON.stringify(entries));
        }

        function loadEntries() {
            const saved = localStorage.getItem('voiceTimeEntries');
            if (saved) {
                entries = JSON.parse(saved);
            }
        }

        function exportAsText() {
            const today = new Date().toDateString();
            const todayEntries = entries.filter(e => new Date(e.date).toDateString() === today);

            if (todayEntries.length === 0) {
                alert('No entries to export for today');
                return;
            }

            const dateStr = new Date().toLocaleDateString();
            let text = `TIME ENTRIES - ${dateStr}\n`;
            text += '='.repeat(60) + '\n\n';

            const typeLabels = {
                'billable': 'Billable',
                'non-billable': 'Non-Billable',
                'billable-pending': 'Billable-Pending'
            };

            todayEntries.forEach((entry, index) => {
                text += `ENTRY ${index + 1}\n`;
                text += `-`.repeat(60) + '\n';
                text += `Client: ${entry.clientName}\n`;
                text += `Matter: ${entry.clientMatter}\n`;
                text += `Type: ${typeLabels[entry.timeType]}\n`;
                text += `Time: ${entry.totalTime} hours\n`;
                text += `Narrative: ${entry.narrative}\n\n`;
            });

            const total = todayEntries.reduce((sum, entry) => sum + entry.totalTime, 0);
            text += '='.repeat(60) + '\n';
            text += `TOTAL TIME: ${total.toFixed(1)} hours\n`;

            navigator.clipboard.writeText(text);
            downloadFile('time-entries.txt', text);
            alert('Exported! Text copied to clipboard and file downloaded.');
        }

        function exportAsCSV() {
            const today = new Date().toDateString();
            const todayEntries = entries.filter(e => new Date(e.date).toDateString() === today);

            if (todayEntries.length === 0) {
                alert('No entries to export for today');
                return;
            }

            let csv = 'Client Name,Client Matter,Time Type,Total Time (hrs),Narrative\n';
            todayEntries.forEach(entry => {
                const narrative = `"${entry.narrative.replace(/"/g, '""')}"`;
                csv += `"${entry.clientName}","${entry.clientMatter}","${entry.timeType}",${entry.totalTime},${narrative}\n`;
            });

            const filename = `time-entries-${new Date().toISOString().split('T')[0]}.csv`;

            // Check if Google Drive is enabled and connected
            if (isGoogleSignedIn && document.getElementById('driveToggle').checked) {
                uploadToDrive(filename, csv, 'text/csv').then(result => {
                    if (result) {
                        // Also download locally as backup
                        downloadFile(filename, csv);
                        alert('CSV saved to Google Drive and downloaded locally!');
                    } else {
                        // Fall back to local download only
                        downloadFile(filename, csv);
                        alert('CSV file downloaded locally (Google Drive upload failed)');
                    }
                });
            } else {
                // Just download locally
                downloadFile(filename, csv);
                alert('CSV file downloaded!');
            }
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Settings Modal Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function toggleNotifications() {
            const isEnabled = document.getElementById('notificationToggle').checked;
            
            if (isEnabled) {
                requestNotificationPermission();
            } else {
                notificationSettings.enabled = false;
                saveNotificationSettings();
                updateNotificationUI();
            }
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                document.getElementById('notificationToggle').checked = false;
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    notificationSettings.enabled = true;
                    saveNotificationSettings();
                    updateNotificationUI();
                    
                    // Send test notification
                    new Notification('Time Tracker Reminders Enabled! üéâ', {
                        body: 'You\'ll receive daily reminders at your chosen time.',
                        icon: 'üé§'
                    });
                } else {
                    document.getElementById('notificationToggle').checked = false;
                    alert('Please enable notifications in your browser settings to use this feature.');
                }
            });
        }

        function updateNotificationUI() {
            const toggle = document.getElementById('notificationToggle');
            const status = document.getElementById('notificationStatus');
            const settings = document.getElementById('notificationSettings');
            
            toggle.checked = notificationSettings.enabled;
            
            if (notificationSettings.enabled) {
                status.innerHTML = '<span class="notification-badge badge-enabled">Enabled</span>';
                settings.classList.remove('hidden');
            } else {
                status.innerHTML = '<span class="notification-badge badge-disabled">Disabled</span>';
                settings.classList.add('hidden');
            }
        }

        function saveNotificationSettings() {
            if (notificationSettings.enabled) {
                notificationSettings.time = document.getElementById('reminderTime').value;
                notificationSettings.days = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                    .map(cb => parseInt(cb.value));
            }
            
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            scheduleNotifications();
            
            if (notificationSettings.enabled) {
                alert('Reminder settings saved! You\'ll be notified at your chosen times.');
            }
        }

        function loadNotificationSettings() {
            const saved = localStorage.getItem('notificationSettings');
            if (saved) {
                notificationSettings = JSON.parse(saved);
                
                // Update UI with saved settings
                document.getElementById('reminderTime').value = notificationSettings.time;
                document.querySelectorAll('.day-checkbox').forEach(cb => {
                    cb.checked = notificationSettings.days.includes(parseInt(cb.value));
                });
            }
        }

        function scheduleNotifications() {
            if (!notificationSettings.enabled) return;

            // Check every minute if it's time to notify
            setInterval(checkDailyReminder, 60000);
        }

        function checkDailyReminder() {
            if (!notificationSettings.enabled) return;

            const now = new Date();
            const currentDay = now.getDay();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // Check if today is a reminder day
            if (!notificationSettings.days.includes(currentDay)) return;
            
            // Check if it's the reminder time
            if (currentTime === notificationSettings.time) {
                // Check if we already sent today
                const lastSent = localStorage.getItem('lastReminderSent');
                const today = now.toDateString();
                
                if (lastSent !== today) {
                    sendDailyReminder();
                    localStorage.setItem('lastReminderSent', today);
                }
            }
        }

        function sendDailyReminder() {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('Time to Track Your Hours! ‚è∞', {
                    body: 'Don\'t forget to log your billable time for today.',
                    icon: 'üé§',
                    requireInteraction: true
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }

        function clearAllEntries() {
            if (confirm('Are you sure you want to delete ALL time entries? This cannot be undone.')) {
                entries = [];
                saveEntries();
                renderEntries();
                alert('All entries have been cleared.');
            }
        }

        function downloadBackup() {
            if (entries.length === 0) {
                alert('No entries to backup');
                return;
            }

            const backup = {
                exportDate: new Date().toISOString(),
                entries: entries
            };

            const json = JSON.stringify(backup, null, 2);
            downloadFile('time-tracker-backup.json', json);
            alert('Backup downloaded successfully!');
        }

        // Google Drive Functions
        function initGoogleDrive() {
            // Check if API credentials are configured
            if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE' || GOOGLE_API_KEY === 'YOUR_API_KEY_HERE') {
                console.log('Google Drive API credentials not configured');
                isGoogleDriveReady = false;
                return;
            }

            gapi.client.init({
                apiKey: GOOGLE_API_KEY,
                clientId: GOOGLE_CLIENT_ID,
                discoveryDocs: GOOGLE_DISCOVERY_DOCS,
                scope: GOOGLE_SCOPES
            }).then(() => {
                isGoogleDriveReady = true;
                
                // Listen for sign-in state changes
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                
                // Handle initial sign-in state
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            }).catch(error => {
                console.error('Error initializing Google Drive API:', error);
                isGoogleDriveReady = false;
            });
        }

        function updateSigninStatus(isSignedIn) {
            isGoogleSignedIn = isSignedIn;
            updateDriveUI();
        }

        function toggleGoogleDrive() {
            const isEnabled = document.getElementById('driveToggle').checked;
            
            if (!isGoogleDriveReady) {
                document.getElementById('driveToggle').checked = false;
                document.getElementById('driveSetup').classList.remove('hidden');
                return;
            }
            
            if (isEnabled && !isGoogleSignedIn) {
                signInToGoogleDrive();
            } else if (!isEnabled && isGoogleSignedIn) {
                signOutFromGoogleDrive();
            }
            
            localStorage.setItem('googleDriveEnabled', isEnabled);
        }

        function signInToGoogleDrive() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                updateDriveUI();
                alert('Successfully connected to Google Drive!');
            }).catch(error => {
                console.error('Error signing in:', error);
                document.getElementById('driveToggle').checked = false;
                alert('Failed to connect to Google Drive. Please try again.');
            });
        }

        function signOutFromGoogleDrive() {
            gapi.auth2.getAuthInstance().signOut().then(() => {
                updateDriveUI();
            });
        }

        function updateDriveUI() {
            const toggle = document.getElementById('driveToggle');
            const status = document.getElementById('driveStatus');
            
            if (isGoogleSignedIn) {
                toggle.checked = true;
                status.innerHTML = '<span class="notification-badge badge-enabled">Connected</span>';
                document.getElementById('driveSetup').classList.add('hidden');
            } else {
                toggle.checked = false;
                status.innerHTML = '<span class="notification-badge badge-disabled">Not Connected</span>';
            }
        }

        function loadGoogleDriveSettings() {
            const enabled = localStorage.getItem('googleDriveEnabled') === 'true';
            if (enabled && isGoogleDriveReady && !isGoogleSignedIn) {
                // Auto sign-in if previously enabled
                setTimeout(() => {
                    signInToGoogleDrive();
                }, 1000);
            }
        }

        async function uploadToDrive(filename, content, mimeType) {
            if (!isGoogleSignedIn) {
                console.error('Not signed in to Google Drive');
                return false;
            }

            try {
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const metadata = {
                    name: filename,
                    mimeType: mimeType
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: ' + mimeType + '\r\n\r\n' +
                    content +
                    close_delim;

                const response = await gapi.client.request({
                    path: '/upload/drive/v3/files',
                    method: 'POST',
                    params: { uploadType: 'multipart' },
                    headers: {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    body: multipartRequestBody
                });

                return response.result;
            } catch (error) {
                console.error('Error uploading to Drive:', error);
                return false;
            }
        }

        function showDriveSetupInstructions() {
            const instructions = `
Google Drive Setup Instructions:

1. Go to: https://console.cloud.google.com/
2. Create a new project or select an existing one
3. Enable the Google Drive API
4. Go to "Credentials" ‚Üí "Create Credentials" ‚Üí "OAuth client ID"
5. Choose "Web application"
6. Add your GitHub Pages URL to "Authorized JavaScript origins":
   https://YOUR-USERNAME.github.io
7. Add redirect URI:
   https://YOUR-USERNAME.github.io/professional_hub
8. Copy the Client ID and API Key
9. Edit index.html and replace:
   - YOUR_CLIENT_ID_HERE with your Client ID
   - YOUR_API_KEY_HERE with your API Key
10. Commit and push to GitHub

After setup, refresh the page and toggle Google Drive integration.
            `;
            
            alert(instructions);
        }

        // Initialize notifications on load
        scheduleNotifications();
    </script>
</body>
</html>
